<html>
    <head>
        <title>Generate Furnace Heat Images per Conditions</title>
        <meta charset="utf-8" />
        <link rel="icon" type="image/x-icon" href="./favicon.png" />
        <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
        <script defer src="https://pyscript.net/latest/pyscript.js"></script>
        <link rel="stylesheet" href="./assets/css/examples.css" />
    </head>
    <body>
        <nav class="navbar" style="background-color: #000000">
            <div class="app-header">
                <a href="">
                    <img src="./logo.png" class="logo" />
                </a>
                <a class="title" href="" style="color: #f0ab3c">KNN avg Generator</a>
            </div>
        </nav>
        <div>Type conditions here: </div>
        <table>
            <tr>
                <td> Ng </td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="0" id="testInput1"/> </td>
                <td> Pci </td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="175" id="testInput2"/> </td>
                <td> H </td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="0" id="testInput3"/> </td>
                <td> Wp </td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="0" id="testInput4"/> </td>
                <td> Ph</td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="300" id="testInput5"/> </td>
            </tr>
            <tr>
                <td> Ox </td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="24" id="testInput6"/> </td>
                <td> Ow </td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="7" id="testInput7"/> </td>
                <td> Hbt</td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="1459" id="testInput8"/> </td>
                <td> Wm</td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="12" id="testInput9"/> </td>
                <td> Wr</td>
                <td> <input type="text" style="border:3px solid #F7730E;" value="308750" id="testInput10"/> </td>
            </tr> 
        </table> 
        <button id="get-time" py-click="my_gen_function()"  class="py-button">Generate</button>
        <p id="current-val"></p>
        <div id="test-output"></div>
        <div id="pandas-output"></div>
        <section class="pyscript"> 
            <div id="mpl"></div>
            <py-config>
                packages = [
                    "matplotlib",
                    "pandas",
                ]
                plugins = [
                    "https://pyscript.net/latest/plugins/python/py_tutor.py"
                ]
            </py-config>
            <script type="py">
                import matplotlib.pyplot as plt
                import numpy as np
                import pandas as pd
                from pyodide.http import open_url
                
                url1 = ("https://lgulbran.github.io/mini_knn_project/PD_ids_train.csv")
                pd_ids_train = pd.read_csv(open_url(url1))
                pd_ids_train_np = pd_ids_train.to_numpy()
                pd_ids_train_np = pd_ids_train_np[1:, 1:]

                url2 = ("https://lgulbran.github.io/mini_knn_project/PD_conditions_train.csv")
                pd_conditions_train = pd.read_csv(open_url(url2))
                pd_conditions_train_np = pd_conditions_train.to_numpy()
                pd_conditions_train_np = pd_conditions_train_np[1:, 1:]

                url3 = ("https://lgulbran.github.io/mini_knn_project/PD_imgs_np_train.csv")
                pd_imgs_np_train = pd.read_csv(open_url(url3))
                pd_imgs_np_train_np = pd_imgs_np_train.to_numpy()
                pd_imgs_np_train_np = pd_imgs_np_train_np[1:, 1:]

                def euclidean_distance(v1, v2):
                    return np.sqrt(np.sum((v1 - v2)**2))

                def predict(test_x):
                    distances = [euclidean_distance(test_x, x) for x in pd_conditions_train_np]
                    k = 3
                    k_neighbor_indices = np.argsort(distances)[:k]
                    selected_imgs_to_avg = [pd_imgs_np_train_np[i].reshape((140, 39)) for i in k_neighbor_indices]
                    avg_gen_img = np.mean(np.array(selected_imgs_to_avg), axis=0)
                    avg_gen_img = avg_gen_img.astype(int)
                    return avg_gen_img

                def get_np_conditions_vector():
                    inputs = [float(Element(f'testInput{i}').element.value) for i in range(1, 11)]
                    np_conditions_list = np.array(inputs)
                    np_conditions_list = np.expand_dims(np_conditions_list, axis=0)
                    return np_conditions_list

                def my_gen_function():
                    test_x = get_np_conditions_vector()
                    # Print shapes for debugging
                    text1 = f"pd_conditions_train_np.shape: {pd_conditions_train_np.shape}\n"
                    text2 = f"pd_ids_train_np.shape: {pd_ids_train_np.shape}\n"
                    text3 = f"pd_imgs_np_train_np.shape: {pd_imgs_np_train_np.shape}\n"
                    text4 = f"test_x.shape: {test_x.shape}"
                    text = text1 + text2 + text3 + text4
                    Element('test-output').element.innerText =  text   
                    
                    generated_img = predict(test_x)
                    fig1, ax1 = plt.subplots()
                    plt.imshow(generated_img)
                    plt.colorbar(label="Colorbar", orientation="vertical")
                    ax1.set_title(str(test_x))
                    display(fig1, target="mpl")
                </script>
            </section>
        </body>
    </

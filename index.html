<html>
<head>
    <title>Mini KNN</title>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="./favicon.png" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="./assets/css/examples.css" />
</head>
<body>
    <nav class="navbar" style="background-color: #000000">
        <div class="app-header">
            <a href="">
                <img src="./logo.png" class="logo" />
            </a>
            <a class="title" href="" style="color: #f0ab3c">KNN avg Generator</a>
        </div>
    </nav>
    <div>Type conditions here: </div>
    <table>
        <tr>
            <td> Feature </td>
            <td> 
                <select id="featureSelect" style="border:3px solid #F7730E;">
                    <option value="0">Medieval</option>
                    <option value="1">Future</option>
                </select>
            </td>
            <td> Character </td>
            <td> 
                <select id="characterSelect" style="border:3px solid #F7730E;">
                    <option value="0">Guts</option>
                    <option value="1">Artorias</option>
                    <option value="2">Space Marine</option>
                    <option value="3">Starcraft Marine</option>
                </select>
            </td>
        </tr>
    </table> 
    <button id="get-time" py-click="my_gen_function()"  class="py-button">Generate</button>
    <p id="current-val"></p>
    <div id="test-output"></div>
    <div id="pandas-output"></div>
    <section class="pyscript"> 
        <div id="mpl"></div>
        <py-config>
            packages = [
                "matplotlib",
                "numpy",
                "pandas"
            ]
            plugins = [
                "https://pyscript.net/latest/plugins/python/py_tutor.py"
            ]
        </py-config>
        <script type="py">
            import matplotlib.pyplot as plt
            import numpy as np
            import pandas as pd
            from pyodide.http import open_url
            
            url1 = ("https://lgulbran.github.io/mini_knn_project/PD_ids_train.csv")
            pd_ids_train = pd.read_csv(open_url(url1))
            pd_ids_train_np = pd_ids_train.to_numpy()
            pd_ids_train_np = pd_ids_train_np[1:, 1:]

            url2 = ("https://lgulbran.github.io/mini_knn_project/PD_conditions_train.csv")
            pd_conditions_train = pd.read_csv(open_url(url2))
            pd_conditions_train_np = pd_conditions_train.to_numpy()
            pd_conditions_train_np = pd_conditions_train_np[1:, 1:]

            url3 = ("https://lgulbran.github.io/mini_knn_project/PD_imgs_np_train.csv")
            pd_imgs_np_train = pd.read_csv(open_url(url3))
            pd_imgs_np_train_np = pd_imgs_np_train.to_numpy()
            pd_imgs_np_train_np = pd_imgs_np_train_np[1:, 1:]

            def euclidean_distance(v1, v2):
                return np.sqrt(np.sum((v1 - v2)**2))

            def predict(test_x):
                distances = [euclidean_distance(test_x, x) for x in pd_conditions_train_np]
                k = 3
                k_neighbor_indices = np.argsort(distances)[:k]
                selected_imgs_to_avg = [pd_imgs_np_train_np[i].reshape((200, 200)) for i in k_neighbor_indices]
                avg_gen_img = np.mean(np.array(selected_imgs_to_avg), axis=0)
                avg_gen_img = avg_gen_img.astype(int)
                return avg_gen_img

            def get_np_conditions_vector():
                feature = Element('featureSelect').element.value
                character = Element('characterSelect').element.value
    
                # Convert feature and character values to floating-point numbers
                    try:
                        feature = float(feature)
                        character = float(character)
                    except ValueError as e:
                        print("Error converting feature or character value to float:", e)
                        return None
    
                # Create separate arrays for feature and character
                np_conditions_list = np.array([feature, character])
                np_conditions_list = np.expand_dims(np_conditions_list, axis=0)
    
                return np_conditions_list


            def my_gen_function():
                test_x = get_np_conditions_vector()
                if test_x is None:
                    return
                # Print shapes for debugging
                text1 = f"pd_conditions_train_np.shape: {pd_conditions_train_np.shape}\n"
                text2 = f"pd_ids_train_np.shape: {pd_ids_train_np.shape}\n"
                text3 = f"pd_imgs_np_train_np.shape: {pd_imgs_np_train_np.shape}\n"
                text4 = f"test_x.shape: {test_x.shape}"
                text = text1 + text2 + text3 + text4
                Element('test-output').element.innerText =  text   
                
                generated_img = predict(test_x)
                fig1, ax1 = plt.subplots()
                plt.imshow(generated_img)
                plt.colorbar(label="Colorbar", orientation="vertical")
                ax1.set_title(str(test_x))
                display(fig1, target="mpl")
        </script>
    </section>
</body>
</html>

